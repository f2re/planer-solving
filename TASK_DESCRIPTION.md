# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Система автоматизированного составления расписания учебных занятий

### 1. ОБЩИЕ СВЕДЕНИЯ

**Название проекта:** Планировщик расписания на базе OR-Tools

**Назначение:** Автоматизированное составление расписания учебных занятий для образовательных учреждений с учетом множественных ограничений и экспорт результатов в формате Excel. [developers.google](https://developers.google.com/optimization/cp/cp_solver)

**Технологический стек:**
- Python 3.11+
- Google OR-Tools CP-SAT Solver (constraint programming) [pganalyze](https://pganalyze.com/blog/a-practical-introduction-to-constraint-programming-using-cp-sat)
- pandas для обработки данных
- openpyxl для генерации Excel
- python-dateutil для работы с датами

### 2. ВОЗМОЖНОСТИ OR-TOOLS CP-SAT SOLVER

OR-Tools CP-SAT — это constraint programming solver от Google, оптимизированный для задач целочисленного программирования. Ключевые возможности для составления расписаний: [d-krupke.github](https://d-krupke.github.io/cpsat-primer/04_modelling.html)

**Жесткие ограничения (hard constraints):**
- Предотвращение конфликтов преподавателей (один преподаватель не может вести два занятия одновременно) [stackoverflow](https://stackoverflow.com/questions/66369778/adding-soft-constraints-to-a-scheduling-problem-in-or-tools-python)
- Предотвращение конфликтов аудиторий (одна аудитория не может использоваться дважды одновременно) [github](https://github.com/ghaithghawarrr/timetable-gen)
- Предотвращение конфликтов групп студентов [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Учет доступности преподавателей и аудиторий [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Контроль типов аудиторий (лекционная, лабораторная, компьютерный класс) [github](https://github.com/ghaithghawarrr/timetable-gen)
- Соблюдение вместимости аудиторий [github](https://github.com/ghaithghawarrr/timetable-gen)

**Мягкие ограничения (soft constraints):**
- Минимизация окон в расписании [stackoverflow](https://stackoverflow.com/questions/66369778/adding-soft-constraints-to-a-scheduling-problem-in-or-tools-python)
- Равномерное распределение нагрузки преподавателей [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Приоритет старших преподавателей [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Группировка последовательных занятий (пары) [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Минимизация переходов между корпусами

**Дополнительные возможности:**
- Поиск нескольких допустимых решений [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
- Настраиваемое время решения задачи
- Поддержка недельных и двухнедельных циклов расписания [github](https://github.com/ghaithghawarrr/timetable-gen)
- Обработка различной длительности занятий (60, 90, 120 минут) [didattica.cs.unicam](http://didattica.cs.unicam.it/lib/exe/fetch.php?media=didattica%3Aay2122%3Alcp%3Aor_tools_03_practiceexercise_and_assignment.pdf)

### 3. ТРЕБОВАНИЯ К ВХОДНЫМ ДАННЫМ

Все входные файлы должны быть в формате **CSV** с кодировкой **UTF-8**, разделитель — **запятая** (`,`), десятичный разделитель — **точка** (`.`).

#### 3.1. Файл преподавателей (`teachers.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `teacher_id` | integer | Уникальный идентификатор | 1 |
| `last_name` | string | Фамилия | Иванов |
| `first_name` | string | Имя | Иван |
| `middle_name` | string | Отчество | Иванович |
| `position` | string | Должность | Доцент, Профессор, Старший преподаватель |
| `max_hours_per_week` | integer | Максимальная недельная нагрузка (часов) | 18 |
| `seniority` | integer | Стаж работы (для приоритезации) | 15 |

**Пример:**
```csv
teacher_id,last_name,first_name,middle_name,position,max_hours_per_week,seniority
1,Иванов,Иван,Иванович,Профессор,18,25
2,Петрова,Мария,Сергеевна,Доцент,20,10
3,Сидоров,Петр,Александрович,Старший преподаватель,24,5
```

#### 3.2. Файл недоступности преподавателей (`teacher_unavailability.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `teacher_id` | integer | ID преподавателя | 1 |
| `start_date` | date (YYYY-MM-DD) | Дата начала недоступности | 2026-03-10 |
| `end_date` | date (YYYY-MM-DD) | Дата окончания недоступности | 2026-03-15 |
| `reason` | string | Причина (отпуск, больничный, командировка) | Отпуск |
| `unavailable_days` | string | Дни недели (опционально, для регулярных выходных) | Monday;Wednesday |

**Пример:**
```csv
teacher_id,start_date,end_date,reason,unavailable_days
1,2026-03-10,2026-03-24,Отпуск,
2,,,Методический день,Monday
3,2026-02-15,2026-02-16,Командировка,
```

#### 3.3. Файл дисциплин и нагрузки (`disciplines.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `discipline_id` | integer | Уникальный ID дисциплины | 101 |
| `discipline_name` | string | Название дисциплины | Высшая математика |
| `group_name` | string | Название группы студентов | ИВТ-21 |
| `group_size` | integer | Количество студентов в группе | 25 |
| `semester` | integer | Семестр | 3 |
| `lecture_hours` | integer | Часов лекций всего | 36 |
| `practice_hours` | integer | Часов практики всего | 36 |
| `lab_hours` | integer | Часов лабораторных всего | 18 |
| `lecturer_id` | integer | ID лектора | 1 |
| `practice_teacher_ids` | string | ID преподавателей практики (через `;`) | 2;3 |
| `lab_teacher_ids` | string | ID преподавателей лабораторных | 3 |

**Пример:**
```csv
discipline_id,discipline_name,group_name,group_size,semester,lecture_hours,practice_hours,lab_hours,lecturer_id,practice_teacher_ids,lab_teacher_ids
101,Высшая математика,ИВТ-21,25,3,36,36,0,1,2,
102,Программирование,ИВТ-21,25,3,36,18,36,2,2,3
103,Базы данных,ИВТ-22,30,3,36,36,18,1,3,3
```

#### 3.4. Файл тематических планов (`thematic_plans.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `discipline_id` | integer | ID дисциплины | 101 |
| `lesson_type` | string | Тип занятия: `lecture`, `practice`, `lab` | lecture |
| `lesson_number` | integer | Порядковый номер занятия | 1 |
| `topic` | string | Тема занятия | Введение в математический анализ |
| `duration_minutes` | integer | Длительность (минут): 90, 120, 180 | 90 |
| `required_room_type` | string | Тип аудитории: `lecture_hall`, `classroom`, `computer_lab`, `laboratory` | lecture_hall |
| `min_capacity` | integer | Минимальная вместимость аудитории | 25 |

**Пример:**
```csv
discipline_id,lesson_type,lesson_number,topic,duration_minutes,required_room_type,min_capacity
101,lecture,1,Введение в математический анализ,90,lecture_hall,25
101,lecture,2,Пределы и непрерывность,90,lecture_hall,25
101,practice,1,Решение задач на пределы,90,classroom,25
102,lab,1,Основы Python,120,computer_lab,15
```

#### 3.5. Файл аудиторий (`rooms.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `room_id` | integer | Уникальный ID аудитории | 1 |
| `room_name` | string | Название/номер аудитории | Ауд. 301 |
| `building` | string | Корпус | Главный корпус |
| `room_type` | string | Тип: `lecture_hall`, `classroom`, `computer_lab`, `laboratory` | lecture_hall |
| `capacity` | integer | Вместимость (мест) | 60 |
| `equipment` | string | Оборудование (опционально) | Проектор;Доска |

**Пример:**
```csv
room_id,room_name,building,room_type,capacity,equipment
1,Ауд. 301,Главный корпус,lecture_hall,60,Проектор;Доска
2,Ауд. 205,Главный корпус,classroom,30,Доска
3,Комп. класс 1,Новый корпус,computer_lab,20,Компьютеры;Проектор
4,Лаб. физики,Главный корпус,laboratory,25,Лабораторное оборудование
```

#### 3.6. Файл временных слотов (`timeslots.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `slot_id` | integer | Уникальный ID слота | 1 |
| `day_of_week` | string | День недели: `Monday`, `Tuesday`, `Wednesday`, `Thursday`, `Friday`, `Saturday` | Monday |
| `start_time` | time (HH:MM) | Время начала | 08:30 |
| `end_time` | time (HH:MM) | Время окончания | 10:00 |
| `duration_minutes` | integer | Длительность (минут) | 90 |
| `slot_number` | integer | Номер пары в дне | 1 |

**Пример:**
```csv
slot_id,day_of_week,start_time,end_time,duration_minutes,slot_number
1,Monday,08:30,10:00,90,1
2,Monday,10:10,11:40,90,2
3,Monday,12:00,13:30,90,3
4,Monday,13:50,15:20,90,4
5,Tuesday,08:30,10:00,90,1
```

#### 3.7. Файл календаря (праздники, выходные) (`calendar.csv`)

**Обязательные поля:**

| Поле | Тип | Описание | Пример |
|------|-----|----------|--------|
| `date` | date (YYYY-MM-DD) | Дата | 2026-03-08 |
| `is_holiday` | boolean (0/1) | Праздничный день | 1 |
| `is_working_day` | boolean (0/1) | Рабочий день (для переносов) | 0 |
| `description` | string | Описание | Международный женский день |

**Пример:**
```csv
date,is_holiday,is_working_day,description
2026-03-08,1,0,Международный женский день
2026-05-01,1,0,День труда
2026-05-09,1,0,День Победы
2026-03-07,0,1,Перенос с воскресенья
```

### 4. ТРЕБОВАНИЯ К ВЫХОДНЫМ ДАННЫМ

#### 4.1. Основной файл результата (`schedule_result.xlsx`)

Excel-файл должен содержать **5 листов**:

##### **Лист 1: "Общее расписание"**

Таблица со всеми занятиями в хронологическом порядке:

| Неделя | Дата | День недели | Время начала | Время окончания | Пара № | Дисциплина | Тип занятия | Тема | Группа | Преподаватель | Аудитория | Корпус |
|--------|------|-------------|--------------|-----------------|--------|------------|-------------|------|--------|---------------|-----------|--------|

**Форматирование:**
- Заголовки: жирный шрифт, серый фон (#D9D9D9), выравнивание по центру
- Чередующиеся строки: белый и светло-голубой фон (#E7F3FF)
- Типы занятий с цветовой кодировкой:
  - Лекция — желтый (#FFF4CC)
  - Практика — зеленый (#E2F0D9)
  - Лабораторная — голубой (#DEEBF7)
- Границы всех ячеек: тонкая черная линия
- Автоширина всех колонок

##### **Лист 2: "Расписание по преподавателям"**

Для каждого преподавателя — отдельный блок:

```
Преподаватель: [ФИО] | Должность: [Должность] | Всего часов: [XX]
────────────────────────────────────────────────────────────────────
| Дата | День | Время | Дисциплина | Тип | Группа | Аудитория |
────────────────────────────────────────────────────────────────────
[данные...]

[пустая строка]
```

**Форматирование:**
- Имя преподавателя: жирный, 12pt, синий цвет (#0070C0)
- Статистика по часам в неделю
- Выделение перегруженных преподавателей (>24 часа/неделя) красным цветом

##### **Лист 3: "Расписание по группам"**

Для каждой группы студентов — сетка расписания:

```
Группа: [Название группы] | Семестр: [X] | Студентов: [XX]
────────────────────────────────────────────────────────────
|         | Понедельник | Вторник | Среда | Четверг | Пятница |
────────────────────────────────────────────────────────────
| 08:30   |             |         |       |         |         |
| 10:10   |             |         |       |         |         |
| 12:00   |             |         |       |         |         |
| 13:50   |             |         |       |         |         |
────────────────────────────────────────────────────────────
```

В ячейках: `Дисциплина\nПреподаватель\nАуд. XXX`

**Форматирование:**
- Окна в расписании выделены серым (#CCCCCC)
- Границы всех ячеек
- Объединение ячеек для занятий длительностью >90 минут

##### **Лист 4: "Использование аудиторий"**

Статистика загрузки аудиторий:

| Аудитория | Корпус | Тип | Вместимость | Занято часов/неделю | Процент загрузки | Основные дисциплины |
|-----------|--------|-----|-------------|---------------------|------------------|---------------------|

**Форматирование:**
- Условное форматирование процента загрузки:
  - 0-50% — зеленый
  - 51-80% — желтый
  - 81-100% — красный

##### **Лист 5: "Метаданные и статистика"**

Общая информация о решении:

```
Дата составления: [дата]
Период расписания: [дата начала] — [дата окончания]
Количество недель: [X]
Solver: Google OR-Tools CP-SAT
Время решения: [X.XX секунд]
Статус решения: [OPTIMAL/FEASIBLE]
Оценка качества (Score): [значение]

═══════════════════════════════════════════════════════
СТАТИСТИКА
═══════════════════════════════════════════════════════
Всего занятий запланировано: [XXX]
Всего преподавателей: [XX]
Всего групп: [XX]
Всего аудиторий: [XX]

Средняя загрузка преподавателей: [XX.X часов/неделю]
Средняя загрузка аудиторий: [XX.X%]
Среднее количество окон на группу: [X.X]

═══════════════════════════════════════════════════════
НАРУШЕННЫЕ МЯГКИЕ ОГРАНИЧЕНИЯ
═══════════════════════════════════════════════════════
[список, если есть]
```

#### 4.2. Файл конфликтов и предупреждений (`warnings.txt`)

Текстовый файл с информацией о проблемах:

```
=== ОТЧЕТ О СОСТАВЛЕНИИ РАСПИСАНИЯ ===
Дата: [timestamp]

[КРИТИЧЕСКИЕ ОШИБКИ]
(если не удалось составить расписание)

[ПРЕДУПРЕЖДЕНИЯ]
- Преподаватель [ФИО] имеет нагрузку [XX] часов (превышение на [X] часов)
- Группа [Название] имеет [X] окон в расписании
- Аудитория [Номер] перегружена ([XX]% занятости)

[ИНФОРМАЦИЯ]
- Учтено [XX] праздничных дней
- Учтено [XX] периодов недоступности преподавателей
- Всего временных слотов: [XXX]
```

### 5. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

#### 5.1. Ограничения модели

**Жесткие ограничения (обязательные):**
1. Один преподаватель не может вести два занятия одновременно [github](https://github.com/ghaithghawarrr/timetable-gen)
2. Одна аудитория не может использоваться дважды одновременно [github](https://github.com/ghaithghawarrr/timetable-gen)
3. Одна группа не может иметь два занятия одновременно [github](https://github.com/ghaithghawarrr/timetable-gen)
4. Вместимость аудитории должна быть >= размера группы [github](https://github.com/ghaithghawarrr/timetable-gen)
5. Тип аудитории должен соответствовать типу занятия [github](https://github.com/ghaithghawarrr/timetable-gen)
6. Преподаватель не может вести занятия в периоды недоступности [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
7. Занятия не могут планироваться на праздничные дни
8. Недельная нагрузка преподавателя не может превышать `max_hours_per_week`
9. Все занятия из тематического плана должны быть запланированы

**Мягкие ограничения (желательные, с весами приоритета):**
1. Минимизация окон в расписании групп (вес: 10) [stackoverflow](https://stackoverflow.com/questions/66369778/adding-soft-constraints-to-a-scheduling-problem-in-or-tools-python)
2. Минимизация окон в расписании преподавателей (вес: 5)
3. Равномерное распределение нагрузки по дням недели (вес: 3) [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
4. Группировка последовательных занятий одной дисциплины (вес: 7) [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
5. Минимизация переходов преподавателей между корпусами (вес: 4)
6. Приоритет более опытных преподавателей при выборе времени (вес: 2) [linkedin](https://www.linkedin.com/posts/catul_unraveling-the-complexities-of-school-timetable-activity-7209333190245699584-MNY5)
7. Избегание занятий в последние пары (вес: 3)

#### 5.2. Параметры запуска

Программа должна поддерживать конфигурационный файл `config.json`:

```json
{
  "input_directory": "./input/",
  "output_directory": "./output/",
  "schedule_start_date": "2026-02-10",
  "schedule_end_date": "2026-06-30",
  "solver_time_limit_seconds": 300,
  "number_of_solutions": 1,
  "soft_constraints": {
    "minimize_student_gaps": {"enabled": true, "weight": 10},
    "minimize_teacher_gaps": {"enabled": true, "weight": 5},
    "balance_workload": {"enabled": true, "weight": 3},
    "group_consecutive_lessons": {"enabled": true, "weight": 7},
    "minimize_building_transitions": {"enabled": true, "weight": 4},
    "teacher_seniority_priority": {"enabled": false, "weight": 2},
    "avoid_late_slots": {"enabled": true, "weight": 3}
  },
  "logging_level": "INFO"
}
```

#### 5.3. Интерфейс командной строки

```bash
python schedule_generator.py --config config.json

# Опциональные параметры
--validate-only          # Только проверка входных данных
--output-format excel    # Формат вывода: excel, json, csv
--verbose               # Подробный вывод
--find-multiple 3       # Найти 3 различных решения
```

### 6. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

#### 6.1. Производительность
- Время решения для 50 групп, 100 преподавателей, 50 аудиторий: не более 5 минут [developers.google](https://developers.google.com/optimization/cp/cp_solver)
- Потребление памяти: не более 2 GB RAM
- Поддержка многопоточности для параллельной обработки

#### 6.2. Надежность
- Валидация всех входных данных с выводом понятных ошибок
- Обработка отсутствующих файлов
- Логирование всех этапов работы в файл `schedule.log`
- Автоматическое создание резервных копий результатов

#### 6.3. Расширяемость
- Модульная архитектура
- Возможность добавления новых типов ограничений
- Поддержка плагинов для экспорта в другие форматы
- API для интеграции с внешними системами

### 7. СТРУКТУРА ПРОЕКТА

```
schedule-generator/
├── input/
│   ├── teachers.csv
│   ├── teacher_unavailability.csv
│   ├── disciplines.csv
│   ├── thematic_plans.csv
│   ├── rooms.csv
│   ├── timeslots.csv
│   └── calendar.csv
├── output/
│   ├── schedule_result.xlsx
│   └── warnings.txt
├── src/
│   ├── __init__.py
│   ├── data_loader.py        # Загрузка и валидация CSV
│   ├── validator.py           # Проверка корректности данных
│   ├── model.py               # Доменные классы
│   ├── solver.py              # Логика OR-Tools
│   ├── constraints.py         # Определение ограничений
│   ├── exporter.py            # Экспорт в Excel
│   └── utils.py               # Вспомогательные функции
├── tests/
│   ├── test_data_loader.py
│   ├── test_validator.py
│   └── test_solver.py
├── config.json
├── requirements.txt
├── schedule_generator.py      # Точка входа
├── README.md
└── schedule.log
```

### 8. ЭТАПЫ РАЗРАБОТКИ

1. **Этап 1:** Разработка модулей загрузки и валидации данных (1 неделя)
2. **Этап 2:** Реализация базовой модели OR-Tools с жесткими ограничениями (2 недели)
3. **Этап 3:** Добавление мягких ограничений и оптимизация (1 неделя)
4. **Этап 4:** Разработка модуля экспорта в Excel (1 неделя)
5. **Этап 5:** Тестирование на реальных данных и оптимизация производительности (1 неделя)
6. **Этап 6:** Документация и подготовка к развертыванию (3 дня)

**Общая длительность:** 6-7 недель

### 9. КРИТЕРИИ ПРИЕМКИ

✅ Программа успешно загружает все входные CSV файлы
✅ Валидация выявляет ошибки в форматах данных
✅ Составляется расписание для тестового набора данных (20 групп, 30 преподавателей)
✅ Соблюдены все жесткие ограничения
✅ Excel-файл соответствует описанному формату
✅ Время решения < 5 минут для типовой задачи
✅ Покрытие кода тестами > 80%
✅ Документация включает примеры использования
